<!DOCTYPE html>
<html lang="id">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>OP Dashboard (Order Pembelian)</title>

    <!-- Bootstrap & jQuery & DataTables & PapaParse -->
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha3/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link
      href="https://cdn.datatables.net/1.13.6/css/dataTables.bootstrap5.min.css"
      rel="stylesheet"
    />
    <script src="https://code.jquery.com/jquery-3.7.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.6/js/dataTables.bootstrap5.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>

    <style>
      body {
        background-color: #f8f9fa;
      }
      .table thead th {
        text-align: center;
      }
      .table-hover tbody tr:hover {
        background-color: #f1f3f5;
      }
      .card {
        border: 1px solid #dee2e6;
        border-radius: 5px;
        background-color: #fff;
        margin-bottom: 12px;
      }
      .card-header {
        font-size: 14px;
        background-color: #292b2e;
        color: #fff;
        padding: 6px 10px;
      }
      .card-body {
        padding: 8px 10px;
        font-size: 14px;
      }
      .small-label {
        font-size: 12px;
        color: #666;
      }
    </style>
  </head>
  <body>
    <div class="container mt-3 mb-5">
      <h3 class="text-center mb-3">
        OP (Order Pembelian) — Dashboard (Cabang GTR)
      </h3>

      <div class="table-responsive">
        <table
          id="opTable"
          class="table table-striped table-hover table-bordered"
          style="width: 100%"
        >
          <thead class="table-dark">
            <tr>
              <th>TransID</th>
              <th>Tanggal</th>
              <th>ID - Nama Karyawan</th>
              <th>Cabang</th>
              <th>Keperluan</th>
              <th>Kode Langganan</th>
              <th>No Pinjam</th>
              <th>No MK</th>
              <th>No Pakai</th>
              <th>No Invoice</th>
              <th>Progress</th>
              <th>Link Form</th>
              <th>Link Update</th>
              <th>Link Batal</th>
              <th>Action</th>
            </tr>
          </thead>
          <tbody id="tableBody"></tbody>
        </table>
      </div>
    </div>

    <!-- Modal detail -->
    <div class="modal fade" id="detailModal" tabindex="-1" aria-hidden="true">
      <div class="modal-dialog modal-xl modal-dialog-scrollable">
        <div class="modal-content">
          <div class="modal-header bg-dark text-white">
            <h5 class="modal-title">Detail Order Pembelian</h5>
            <button
              type="button"
              class="btn-close btn-close-white"
              data-bs-dismiss="modal"
            ></button>
          </div>
          <div class="modal-body" id="modalBodyContent"></div>
          <div class="modal-footer">
            <button class="btn btn-secondary" data-bs-dismiss="modal">
              Tutup
            </button>
          </div>
        </div>
      </div>
    </div>

    <script>
      /*
  Column mapping (zero-based):
    A=0, B=1, C=2, D=3, E=4, F=5, G=6, H=7, I=8, J=9,
    K=10, L=11, M=12, N=13, O=14, P=15, Q=16, R=17, S=18, T=19,
    U=20, V=21, W=22, X=23, Y=24, Z=25, AA=26, AB=27, AC=28, AD=29,
    AE=30, AF=31, AG=32, AH=33, AI=34, AJ=35, AK=36, AL=37,
    AM=38 (Alasan Update), AN=39 (Alasan Batal),
    AO=40 (Progress), AP=41 (Link Form), AQ=42 (Link Update), AR=43 (Link Batal)
*/

      const csvUrl =
        "https://docs.google.com/spreadsheets/d/e/2PACX-1vTgFVU5uh5mKvnk1z7_tvmjWV1rV4QURPNQWySOvFt5HL-Hdo2D-2kA8uN3NzxAe7WQBB2oRPwr7n-z/pub?gid=12863231&single=true&output=csv";

      let headerRow = [];
      let dataRows = [];

      function safe(v) {
        return v === undefined || v === null || String(v).trim() === ""
          ? "-"
          : String(v);
      }
      function mkHref(v) {
        if (!v) return "#";
        const s = String(v).trim();
        return s.startsWith("http") ? s : "//" + s;
      }
      function toISODateIfPossible(v) {
        if (!v) return "";
        const d = new Date(v);
        if (isNaN(d)) return "";
        return d.toISOString();
      }

      // form templates used earlier (kept for Link Form)
      const FORM_TEMPLATES = {
        COMPLETE_PINJAM: {
          base: "https://docs.google.com/forms/d/e/1FAIpQLSdVsv0JTkIqsfVkhlkw23RY1WjUqnp19s9drnybDODO0ZbQIg/viewform?usp=pp_url",
          params: { transid: "entry.2064848191", noPinjam: "entry.460873802" },
        },
        COMPLETE_PAKAI: {
          base: "https://docs.google.com/forms/d/e/1FAIpQLSe8Jh7oPmx9uvpfgCwTZQ8RqRmOup5AagaAGk9TFJ-08XhugA/viewform?usp=pp_url",
          params: { transid: "entry.432593474", noPakai: "entry.1727915460" },
        },
        PENGEMBALIAN_BARANG: {
          base: "https://docs.google.com/forms/d/e/1FAIpQLScJZoqFXjI192kFfaiWEs21bKfkFuhNBMPoNJq43pOnNVSMgw/viewform?usp=pp_url",
          params: { transid: "entry.572093642", noPinjam: "entry.1649777772" },
        },
        PEMAKAIAN_BARANG: {
          base: "https://docs.google.com/forms/d/e/1FAIpQLSeoytV3aY1jc--oPTw5wUfItQFE7oryB0N5fW_88XaGLN2DuQ/viewform?usp=pp_url",
          params: { transid: "entry.2146827387", noPakai: "entry.571553466" },
        },
      };

      function col(row, idx) {
        if (!row) return "";
        return idx < 0 || idx >= row.length ? "" : row[idx];
      }

      // Build Link Form from label (same as before)
      function buildFormUrlFromLabel(label, row) {
        if (!label) return "";
        const L = String(label).toUpperCase().trim();
        const transid = String(col(row, 3) || "").trim();
        const noPinjam = String(col(row, 8) || "").trim();
        const noPakai = String(col(row, 23) || "").trim();

        if (L.includes("COMPLETE PINJAM")) {
          const tpl = FORM_TEMPLATES.COMPLETE_PINJAM;
          return `${tpl.base}&${tpl.params.transid}=${encodeURIComponent(
            transid
          )}&${tpl.params.noPinjam}=${encodeURIComponent(noPinjam)}`;
        }
        if (L.includes("COMPLETE PAKAI")) {
          const tpl = FORM_TEMPLATES.COMPLETE_PAKAI;
          return `${tpl.base}&${tpl.params.transid}=${encodeURIComponent(
            transid
          )}&${tpl.params.noPakai}=${encodeURIComponent(noPakai)}`;
        }
        if (L.includes("PENGEMBALIAN")) {
          const tpl = FORM_TEMPLATES.PENGEMBALIAN_BARANG;
          return `${tpl.base}&${tpl.params.transid}=${encodeURIComponent(
            transid
          )}&${tpl.params.noPinjam}=${encodeURIComponent(noPinjam)}`;
        }
        if (L.includes("PEMAKAIAN")) {
          const tpl = FORM_TEMPLATES.PEMAKAIAN_BARANG;
          return `${tpl.base}&${tpl.params.transid}=${encodeURIComponent(
            transid
          )}&${tpl.params.noPakai}=${encodeURIComponent(noPakai)}`;
        }
        return "";
      }

      // ----------------------------
      // Build Update URL (AQ) from row (mimic your ARRAYFORMULA building)
      // ----------------------------
      function buildUpdateUrlFromRow(row) {
        const typeRaw = String(col(row, 6) || "").trim(); // G
        const type = typeRaw.replace(/\u00A0/g, "").toLowerCase();
        const transid = encodeURIComponent(String(col(row, 3) || "").trim()); // D

        // Form base (your formula used same form id for both pinjam/pakai)
        const base =
          "https://docs.google.com/forms/d/e/1FAIpQLSc_tZolSs9jjLNppQ6RwUQmBVFl-xt3el7JM3V7DXcqIYseKw/viewform?usp=pp_url";

        if (type === "pinjam") {
          // Mapping K..V => cols 10..21
          const map = {
            "entry.1857583927": col(row, 10), // K
            "entry.51449392": col(row, 11), // L
            "entry.725536808": col(row, 12), // M
            "entry.1585152426": col(row, 13), // N
            "entry.1247191112": col(row, 14), // O
            "entry.521804809": col(row, 15), // P
            "entry.1103266424": col(row, 16), // Q
            "entry.1262921988": col(row, 17), // R
            "entry.1605010623": col(row, 18), // S
            "entry.1461492477": col(row, 19), // T
            "entry.1598462406": col(row, 20), // U
            "entry.2061006561": col(row, 21), // V
          };
          let url = base + "&entry.331942194=" + transid;
          for (const key in map) {
            const v = (map[key] || "").trim();
            if (v !== "") url += `&${key}=${encodeURIComponent(v)}`;
            else url += `&${key}=`;
          }
          return { href: url, label: "UPDATE PINJAM" };
        }

        if (type === "pakai") {
          // Mapping Z..AK => cols 25..36
          const map = {
            "entry.1857583927": col(row, 25), // Z
            "entry.51449392": col(row, 26), // AA
            "entry.725536808": col(row, 27), // AB
            "entry.1585152426": col(row, 28), // AC
            "entry.1247191112": col(row, 29), // AD
            "entry.521804809": col(row, 30), // AE
            "entry.1103266424": col(row, 31), // AF
            "entry.1262921988": col(row, 32), // AG
            "entry.1605010623": col(row, 33), // AH
            "entry.1461492477": col(row, 34), // AI
            "entry.1598462406": col(row, 35), // AJ
            "entry.2061006561": col(row, 36), // AK
          };
          let url = base + "&entry.331942194=" + transid;
          for (const key in map) {
            const v = (map[key] || "").trim();
            if (v !== "") url += `&${key}=${encodeURIComponent(v)}`;
            else url += `&${key}=`;
          }
          return { href: url, label: "UPDATE PAKAI" };
        }

        return { href: "", label: "" };
      }

      // ----------------------------
      // Build Batal URL (AR) from row
      // ----------------------------
      function buildBatalUrlFromRow(row) {
        const typeRaw = String(col(row, 6) || "").trim(); // G
        const type = typeRaw.replace(/\u00A0/g, "").toLowerCase();
        const transid = encodeURIComponent(String(col(row, 3) || "").trim()); // D

        const base =
          "https://docs.google.com/forms/d/e/1FAIpQLScgU2-saF_fxbM1NeH-z_lniidrP3G250BNIR3Kg5kupVzT8Q/viewform?usp=pp_url";

        if (type === "pinjam") {
          const url = base + "&entry.1515460522=" + transid;
          return { href: url, label: "BATAL PINJAM" };
        }
        if (type === "pakai") {
          const url = base + "&entry.1515460522=" + transid;
          return { href: url, label: "BATAL PAKAI" };
        }
        return { href: "", label: "" };
      }

      // helper to create an "empty" row that has the exact number of <td> as headers
      function emptyRowCells(message = "Tidak ada data", cols = 15) {
        let tds = "";
        for (let i = 0; i < cols; i++) {
          // put message in first cell, others put '-'
          if (i === 0) tds += `<td class="text-center">${message}</td>`;
          else tds += "<td>-</td>";
        }
        return `<tr>${tds}</tr>`;
      }

      $(document).ready(function () {
        Papa.parse(csvUrl, {
          download: true,
          header: false,
          skipEmptyLines: true,
          complete: function (results) {
            const all = results.data || [];
            if (all.length === 0) {
              // Instead of colspan, produce 15 <td>
              $("#tableBody").html(emptyRowCells("Tidak ada data", 15));
              // init DataTable after tableBody populated
              if ($.fn.DataTable.isDataTable("#opTable")) {
                $("#opTable").DataTable().destroy();
              }
              $("#opTable").DataTable({
                responsive: true,
                pageLength: 15,
                order: [[1, "desc"]],
                columnDefs: [
                  { targets: [10, 11, 12, 13], className: "text-center" },
                ],
              });
              return;
            }
            headerRow = all[0] || [];
            dataRows = all.slice(1);
            buildTableFromRows(dataRows);

            if ($.fn.DataTable.isDataTable("#opTable")) {
              $("#opTable").DataTable().destroy();
            }
            $("#opTable").DataTable({
              responsive: true,
              pageLength: 15,
              order: [[1, "desc"]],
              columnDefs: [
                { targets: [10, 11, 12, 13], className: "text-center" },
              ],
            });
          },
          error: function (err) {
            console.error("PapaParse error", err);
            // show empty row with message
            $("#tableBody").html(emptyRowCells("Gagal memuat CSV", 15));
            if ($.fn.DataTable.isDataTable("#opTable")) {
              $("#opTable").DataTable().destroy();
            }
            $("#opTable").DataTable({
              responsive: true,
              pageLength: 15,
              order: [[1, "desc"]],
              columnDefs: [
                { targets: [10, 11, 12, 13], className: "text-center" },
              ],
            });
          },
        });
      });

      function buildTableFromRows(rows) {
        const $tbody = $("#tableBody");
        $tbody.empty();
        if (!rows || rows.length === 0) {
          $tbody.append(emptyRowCells("Tidak ada data", 15));
          return;
        }

        // ---- FILTER: hanya tampilkan cabang GTR ----
        const filtered = rows.filter((r) => {
          const cabangRaw = String(col(r, 5) || "")
            .trim()
            .toLowerCase();
          return cabangRaw === "gtr";
        });

        if (filtered.length === 0) {
          $tbody.append(emptyRowCells("Tidak ada data (GTR)", 15));
          return;
        }
        // -------------------------------------------

        filtered.forEach((r, idx) => {
          const transID = safe(col(r, 3)); // D
          const dateRaw = col(r, 1); // B
          const dateOrder = toISODateIfPossible(dateRaw);
          const idNama = safe(col(r, 4)); // E
          const cabang = safe(col(r, 5)); // F
          const keperluan = safe(col(r, 6)); // G
          const kodeLang = safe(col(r, 7)); // H
          const noPinjam = safe(col(r, 8)); // I
          const noMK = safe(col(r, 9)); // J
          const noPakai = safe(col(r, 23)); // X
          const noInvoice = safe(col(r, 24)); // Y

          const progressRaw = String(col(r, 40) || ""); // AO
          const progressNorm = progressRaw.trim().toLowerCase();
          const alasanUpdateRaw = String(col(r, 38) || ""); // AM
          const alasanUpdateExists = alasanUpdateRaw.trim() !== "";

          const rawLinkForm = col(r, 41); // AP
          const rawLinkUpdate = col(r, 42); // AQ
          const rawLinkBatal = col(r, 43); // AR

          // RULES:
          // - if progress contains "in process" -> hide AQ & AR
          // - if alasan update exists -> hide AQ
          // - if progress contains "cancel" -> hide AP, AQ, AR

          const isInProcess = progressNorm.includes("in process");
          const isCanceled = progressNorm.includes("cancel"); // covers cancel/canceled/cancelled
          const hideUpdate = isInProcess || alasanUpdateExists || isCanceled;
          const hideBatal = isInProcess || isCanceled;
          const hideForm = isCanceled;

          // Link Form: same as before but respect hideForm
          let linkFormHref = "";
          let linkFormLabel = "-";
          if (!hideForm && rawLinkForm && String(rawLinkForm).trim() !== "") {
            const v = String(rawLinkForm).trim();
            if (
              v.toLowerCase().startsWith("http") ||
              v.indexOf("docs.google.com/forms") >= 0
            ) {
              linkFormHref = v;
              linkFormLabel = "Form";
            } else {
              const built = buildFormUrlFromLabel(v, r);
              if (built) {
                linkFormHref = built;
                linkFormLabel = v;
              } else linkFormLabel = v;
            }
          } else {
            // hidden or empty → show dash
            linkFormLabel = "-";
          }

          // Link Update: if hideUpdate -> don't show link
          let linkUpdateHref = "";
          let linkUpdateLabel = "-";
          if (!hideUpdate) {
            if (
              rawLinkUpdate &&
              String(rawLinkUpdate).trim() !== "" &&
              String(rawLinkUpdate).trim().toLowerCase().startsWith("http")
            ) {
              linkUpdateHref = String(rawLinkUpdate).trim();
              linkUpdateLabel = "Update";
            } else {
              const built = buildUpdateUrlFromRow(r);
              if (built && built.href) {
                linkUpdateHref = built.href;
                linkUpdateLabel = built.label || "Update";
              } else {
                linkUpdateLabel = safe(rawLinkUpdate);
              }
            }
          } else {
            linkUpdateLabel = "-";
          }

          // Link Batal: if hideBatal -> don't show link
          let linkBatalHref = "";
          let linkBatalLabel = "-";
          if (!hideBatal) {
            if (
              rawLinkBatal &&
              String(rawLinkBatal).trim() !== "" &&
              String(rawLinkBatal).trim().toLowerCase().startsWith("http")
            ) {
              linkBatalHref = String(rawLinkBatal).trim();
              linkBatalLabel = "Batal";
            } else {
              const built = buildBatalUrlFromRow(r);
              if (built && built.href) {
                linkBatalHref = built.href;
                linkBatalLabel = built.label || "Batal";
              } else {
                linkBatalLabel = safe(rawLinkBatal);
              }
            }
          } else {
            linkBatalLabel = "-";
          }

          const $tr = $("<tr>");
          $tr.append($("<td>").text(transID));
          $tr.append(
            $("<td>").attr("data-order", dateOrder).text(safe(dateRaw))
          );
          $tr.append($("<td>").text(idNama));
          $tr.append($("<td>").text(cabang));
          $tr.append($("<td>").text(keperluan));
          $tr.append($("<td>").text(kodeLang));
          $tr.append($("<td>").text(noPinjam));
          $tr.append($("<td>").text(noMK));
          $tr.append($("<td>").text(noPakai));
          $tr.append($("<td>").text(noInvoice));
          $tr.append($("<td>").text(progressNorm ? safe(progressRaw) : "-"));

          if (linkFormHref) {
            $tr.append(
              $("<td>").html(
                `<a class="btn btn-sm btn-outline-primary" href="${mkHref(
                  linkFormHref
                )}" target="_blank">${linkFormLabel || "Form"}</a>`
              )
            );
          } else {
            $tr.append(
              $("<td>").text(linkFormLabel === "-" ? "-" : linkFormLabel)
            );
          }

          if (linkUpdateHref) {
            $tr.append(
              $("<td>").html(
                `<a class="btn btn-sm btn-outline-success" href="${mkHref(
                  linkUpdateHref
                )}" target="_blank">${linkUpdateLabel}</a>`
              )
            );
          } else {
            $tr.append($("<td>").text(linkUpdateLabel));
          }

          if (linkBatalHref) {
            $tr.append(
              $("<td>").html(
                `<a class="btn btn-sm btn-outline-danger" href="${mkHref(
                  linkBatalHref
                )}" target="_blank">${linkBatalLabel}</a>`
              )
            );
          } else {
            $tr.append($("<td>").text(linkBatalLabel));
          }

          const lihatBtn = $("<button>")
            .addClass("btn btn-sm btn-primary")
            .attr("data-index", idx)
            .text("Lihat")
            .on("click", function () {
              showModalDetailByRowIndex($(this).data("index"));
            });
          $tr.append($("<td>").append(lihatBtn));

          $tbody.append($tr);
        });
      }

      function showModalDetailByRowIndex(rowIndex) {
        const row = dataRows[rowIndex];
        if (!row) {
          $("#modalBodyContent").html("<p>Data tidak ditemukan</p>");
          const m = new bootstrap.Modal(document.getElementById("detailModal"));
          m.show();
          return;
        }

        const data = {
          transid: safe(col(row, 3)),
          date: safe(col(row, 1)),
          idnama: safe(col(row, 4)),
          cabang: safe(col(row, 5)),
          keperluan: safe(col(row, 6)),
          kodeLangganan: safe(col(row, 7)),
          noPinjam: safe(col(row, 8)),
          noMK: safe(col(row, 9)),
          uploadPinjam: col(row, 22),
          noPakai: safe(col(row, 23)),
          noInvoice: safe(col(row, 24)),
          uploadPakai: col(row, 37),
          progress: safe(col(row, 40)),
          rawLinkForm: col(row, 41),
          rawAlasanUpdate: col(row, 38),
          rawAlasanBatal: col(row, 39),
          rawLinkUpdate: col(row, 42),
          rawLinkBatal: col(row, 43),
        };

        // normalize checks (same as table)
        const progressNorm = String(data.progress || "")
          .trim()
          .toLowerCase();
        const isInProcess = progressNorm.includes("in process");
        const isCanceled = progressNorm.includes("cancel");
        const alasanUpdateExists =
          String(data.rawAlasanUpdate || "").trim() !== "";

        const hideUpdate = isInProcess || alasanUpdateExists || isCanceled;
        const hideBatal = isInProcess || isCanceled;
        const hideForm = isCanceled;

        // Pinjam items
        const pinjamCols = [
          [10, 11],
          [12, 13],
          [14, 15],
          [16, 17],
          [18, 19],
          [20, 21],
        ];
        const pinjamItems = [];
        pinjamCols.forEach((pair) => {
          const kode = col(row, pair[0]);
          const qty = col(row, pair[1]);
          if (
            (kode && String(kode).trim() !== "") ||
            (qty && String(qty).trim() !== "")
          )
            pinjamItems.push({ kode: safe(kode), qty: safe(qty) });
        });

        // Pakai items
        const pakaiCols = [
          [25, 26],
          [27, 28],
          [29, 30],
          [31, 32],
          [33, 34],
          [35, 36],
        ];
        const pakaiItems = [];
        pakaiCols.forEach((pair) => {
          const kode = col(row, pair[0]);
          const qty = col(row, pair[1]);
          if (
            (kode && String(kode).trim() !== "") ||
            (qty && String(qty).trim() !== "")
          )
            pakaiItems.push({ kode: safe(kode), qty: safe(qty) });
        });

        // Link Form (respect hideForm)
        let linkFormHref = "";
        let linkFormLabel = "-";
        if (
          !hideForm &&
          data.rawLinkForm &&
          String(data.rawLinkForm).trim() !== ""
        ) {
          const v = String(data.rawLinkForm).trim();
          if (
            v.toLowerCase().startsWith("http") ||
            v.indexOf("docs.google.com/forms") >= 0
          ) {
            linkFormHref = v;
            linkFormLabel = "Form";
          } else {
            const built = buildFormUrlFromLabel(v, row);
            if (built) {
              linkFormHref = built;
              linkFormLabel = v;
            } else linkFormLabel = v;
          }
        } else {
          linkFormLabel = "-";
        }

        // Link Update & Batal (respect hide flags)
        let linkUpdateHref = "";
        let linkUpdateLabel = "-";
        if (!hideUpdate) {
          if (
            data.rawLinkUpdate &&
            String(data.rawLinkUpdate).trim() !== "" &&
            String(data.rawLinkUpdate).trim().toLowerCase().startsWith("http")
          ) {
            linkUpdateHref = String(data.rawLinkUpdate).trim();
            linkUpdateLabel = "Update";
          } else {
            const built = buildUpdateUrlFromRow(row);
            if (built && built.href) {
              linkUpdateHref = built.href;
              linkUpdateLabel = built.label || "Update";
            } else linkUpdateLabel = safe(data.rawLinkUpdate);
          }
        } else {
          linkUpdateLabel = "-";
        }

        let linkBatalHref = "";
        let linkBatalLabel = "-";
        if (!hideBatal) {
          if (
            data.rawLinkBatal &&
            String(data.rawLinkBatal).trim() !== "" &&
            String(data.rawLinkBatal).trim().toLowerCase().startsWith("http")
          ) {
            linkBatalHref = String(data.rawLinkBatal).trim();
            linkBatalLabel = "Batal";
          } else {
            const built = buildBatalUrlFromRow(row);
            if (built && built.href) {
              linkBatalHref = built.href;
              linkBatalLabel = built.label || "Batal";
            } else linkBatalLabel = safe(data.rawLinkBatal);
          }
        } else {
          linkBatalLabel = "-";
        }

        // Build modal HTML
        let html = '<div class="container-fluid">';
        html += '<div class="row mb-2">';
        html += cardCol("TransID", data.transid);
        html += cardCol("Tanggal", data.date);
        html += cardCol("ID - Nama Karyawan", data.idnama);
        html += cardCol("Cabang", data.cabang);
        html += "</div>";

        html += '<div class="row mb-2">';
        html += cardCol("Keperluan", data.keperluan, 12);
        html += "</div>";

        html += '<div class="row mb-2">';
        html += cardCol("Kode Langganan", data.kodeLangganan);
        html += cardCol("No Pinjam", data.noPinjam);
        html += cardCol("No MK", data.noMK);
        html += cardCol("No Pakai", data.noPakai);
        html += cardCol("No Invoice", data.noInvoice);
        html += "</div>";

        html += '<div class="row mb-2">';
        html += cardCol(
          "Upload Pinjam",
          data.uploadPinjam
            ? `<a href="${mkHref(data.uploadPinjam)}" target="_blank">Lihat</a>`
            : "-"
        );
        html += cardCol(
          "Upload Pakai",
          data.uploadPakai
            ? `<a href="${mkHref(data.uploadPakai)}" target="_blank">Lihat</a>`
            : "-"
        );
        html += cardCol("Progress", data.progress);
        html += cardCol(
          "Link Form",
          linkFormHref
            ? `<a href="${mkHref(linkFormHref)}" target="_blank">${safe(
                linkFormLabel
              )}</a>`
            : safe(linkFormLabel)
        );
        html += "</div>";

        // Alasan Update / Alasan Batal
        html += '<div class="row mb-2">';
        html += cardCol("Alasan Update", safe(data.rawAlasanUpdate), 6);
        html += cardCol("Alasan Batal", safe(data.rawAlasanBatal), 6);
        html += "</div>";

        // Link Update & Batal (detail)
        html += '<div class="row mb-2">';
        html += cardCol(
          "Link Update",
          linkUpdateHref
            ? `<a href="${mkHref(linkUpdateHref)}" target="_blank">${safe(
                linkUpdateLabel
              )}</a>`
            : safe(linkUpdateLabel)
        );
        html += cardCol(
          "Link Batal",
          linkBatalHref
            ? `<a href="${mkHref(linkBatalHref)}" target="_blank">${safe(
                linkBatalLabel
              )}</a>`
            : safe(linkBatalLabel)
        );
        html += "</div>";

        // Pinjam table
        html +=
          '<div class="row mt-3"><div class="col-12"><h6>Detail Barang — Pinjam</h6>';
        if (pinjamItems.length === 0)
          html +=
            '<div class="card"><div class="card-body">Tidak ada item pinjam</div></div>';
        else {
          html +=
            '<div class="table-responsive"><table class="table table-sm table-bordered"><thead class="table-light"><tr><th>#</th><th>Kode Barang</th><th>QTY</th></tr></thead><tbody>';
          pinjamItems.forEach((it, i) => {
            html += `<tr><td>${i + 1}</td><td>${safe(it.kode)}</td><td>${safe(
              it.qty
            )}</td></tr>`;
          });
          html += "</tbody></table></div>";
        }
        html += "</div></div>";

        // Pakai table
        html +=
          '<div class="row mt-3"><div class="col-12"><h6>Detail Barang — Pakai</h6>';
        if (pakaiItems.length === 0)
          html +=
            '<div class="card"><div class="card-body">Tidak ada item pakai</div></div>';
        else {
          html +=
            '<div class="table-responsive"><table class="table table-sm table-bordered"><thead class="table-light"><tr><th>#</th><th>Kode Barang</th><th>QTY</th></tr></thead><tbody>';
          pakaiItems.forEach((it, i) => {
            html += `<tr><td>${i + 1}</td><td>${safe(it.kode)}</td><td>${safe(
              it.qty
            )}</td></tr>`;
          });
          html += "</tbody></table></div>";
        }
        html += "</div></div>";

        html += "</div>"; // container-fluid end

        $("#modalBodyContent").html(html);
        const m = new bootstrap.Modal(document.getElementById("detailModal"));
        m.show();
      }

      function cardCol(title, body, colSize = 3) {
        return `<div class="col-12 col-md-${colSize}"><div class="card"><div class="card-header">${title}</div><div class="card-body">${body}</div></div></div>`;
      }
    </script>
  </body>
</html>
